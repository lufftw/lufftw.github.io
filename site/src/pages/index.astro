---
/**
 * Home page
 *
 * Structure:
 * - Header
 * - Page title + RSS
 * - Hero carousel (featured-only)
 * - Featured post (single, editorial)
 * - Two-column layout:
 *   - Main content: latest posts list
 *   - Sidebar: search, about, categories, latest
 */

import { getCollection } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import Hr from "@/components/Hr.astro";
import LinkButton from "@/components/LinkButton.astro";
import getSortedPosts from "@/utils/getSortedPosts";
import IconRss from "@/assets/icons/IconRss.svg";
import IconArrowRight from "@/assets/icons/IconArrowRight.svg";
import { SITE } from "@/config";

import HeroCarousel from "@/components/home/HeroCarousel.astro";
import Sidebar from "@/components/home/Sidebar.astro";
import PostCardHorizontal from "@/components/PostCardHorizontal.astro";
import FeaturedPostCard from "@/components/FeaturedPostCard.astro";

// Fetch all blog entries and keep only posts
const allPosts = await getCollection("blog");
const posts = allPosts.filter(({ data }) => data.type === "post");

// Sort posts by date (descending)
const sortedPosts = getSortedPosts(posts);

// Editorially featured posts (can be 0..N)
const featuredPosts = sortedPosts.filter(({ data }) => data.featured);

/**
 * Hero carousel: featured-only
 * - No fallback to latest posts
 * - If there are no featured posts, hero carousel will not render
 */
const heroItems = featuredPosts.slice(0, 5);

// Build a set of hero slugs to prevent duplication across sections
const heroSlugs = new Set(heroItems.map((p) => p.id));

/**
 * Homepage single featured card:
 * - Pick the first featured post that is NOT already shown in the hero carousel
 * - This avoids showing the same post twice on the homepage
 */
const featuredPost = featuredPosts.find((p) => !heroSlugs.has(p.id));

/**
 * Main list items:
 * - Exclude hero items and the single featured card item (if present)
 */
// const excludedSlugs = new Set([
//   ...heroItems.map((p) => p.id),
//   featuredPost?.id,
// ]);

const listItems = sortedPosts
  .slice(0, SITE.postPerIndex ?? 12);
---

<Layout>
  <Header />

  <main id="main-content" data-layout="index">
    <div class="mx-auto w-full max-w-app px-4">
      <!-- Page title and RSS -->
      <section class="pt-8 pb-4 !mx-0 !max-w-none !px-0">
        <div class="flex items-center gap-3">
          <h1 class="text-4xl font-bold sm:text-5xl">Mingalaba</h1>

          <a
            href="/rss.xml"
            target="_blank"
            aria-label="RSS feed"
            title="RSS Feed"
          >
            <IconRss
              width={20}
              height={20}
              class="scale-125 stroke-accent stroke-3 rtl:-rotate-90"
            />
            <span class="sr-only">RSS Feed</span>
          </a>
        </div>

        <p class="mt-4 max-w-2xl text-slate-600">
          A long-term log of systems, algorithms, and engineering practice.
        </p>
      </section>

      <!-- Hero carousel (featured-only) -->
      {heroItems.length > 0 && <HeroCarousel items={heroItems} />}

      <!-- Featured post (single, editorial; not duplicated with hero) -->
      {featuredPost && (
        <section class="mt-10 !mx-0 !max-w-none !px-0">
          <FeaturedPostCard {...featuredPost} />
        </section>
      )}

      <!-- Main content + sidebar -->
      <div class="mt-10 grid grid-cols-1 gap-10 lg:grid-cols-12">
        <!-- Main post list -->
        <section class="lg:col-span-8 !mx-0 !max-w-none !px-0">
          <h2 class="text-2xl font-semibold tracking-wide">Latest</h2>

          <Hr />

          <ul class="space-y-6">
            {listItems.map((entry) => (
              <li>
                <PostCardHorizontal {...entry} />
              </li>
            ))}
          </ul>

          <div class="my-8 text-center">
            <LinkButton href="/posts/">
              All Posts
              <IconArrowRight class="inline-block rtl:-rotate-180" />
            </LinkButton>
          </div>
        </section>

        <!-- Sidebar -->
        <aside class="lg:col-span-4">
          <Sidebar entries={sortedPosts} />
        </aside>
      </div>
    </div>
  </main>

  <Footer />
</Layout>

<script>
  /**
   * Preserve back-navigation behavior for post detail pages.
   * This allows returning to the homepage correctly.
   */
  document.addEventListener("astro:page-load", () => {
    const indexLayout = (document
      .querySelector("#main-content") as HTMLElement)
      ?.dataset?.layout;

    if (indexLayout) {
      sessionStorage.setItem("backUrl", "/");
    }
  });
</script>
