---
/**
 * Home page (Logbook-style layout)
 *
 * Structure:
 * - Header
 * - Page title + RSS
 * - Hero carousel (featured or recent posts)
 * - Two-column layout:
 *   - Main content: latest posts list
 *   - Sidebar: search, about, categories, latest
 */

import { getCollection } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import Card from "@/components/Card.astro";
import Hr from "@/components/Hr.astro";
import LinkButton from "@/components/LinkButton.astro";
import getSortedPosts from "@/utils/getSortedPosts";
import IconRss from "@/assets/icons/IconRss.svg";
import IconArrowRight from "@/assets/icons/IconArrowRight.svg";
import { SITE } from "@/config";

import HeroCarousel from "@/components/home/HeroCarousel.astro";
import Sidebar from "@/components/home/Sidebar.astro";
import PostCardHorizontal from "@/components/PostCardHorizontal.astro";
import FeaturedPostCard from "@/components/FeaturedPostCard.astro";

// Fetch all blog entries and keep only posts
const allPosts = await getCollection("blog");
const posts = allPosts.filter(({ data }) => data.type === "post");

// Sort posts by date (descending)
const sortedPosts = getSortedPosts(posts);

// Separate featured and non-featured posts
const featuredPosts = sortedPosts.filter(({ data }) => data.featured);
const recentPosts = sortedPosts.filter(({ data }) => !data.featured);

// Select a single featured post for homepage display
const featuredPost = featuredPosts[0];

// Hero carousel data:
// Prefer featured posts; fallback to latest posts
const heroItems = (featuredPosts.length ? featuredPosts : sortedPosts).slice(0, 5);

// Exclude hero items from the main list to avoid duplication
const heroSlugs = new Set(heroItems.map(p => p.slug));
const listItems = sortedPosts
  .filter(p => !heroSlugs.has(p.slug))
  .slice(0, SITE.postPerIndex ?? 12);
---

<Layout>
  <Header />

  <main id="main-content" data-layout="index">
    <div class="mx-auto w-full max-w-6xl px-4">
      <!-- Page title and RSS -->
      <section class="pt-8 pb-4">
        <div class="flex items-center gap-3">
          <h1 class="text-4xl font-bold sm:text-5xl">Mingalaba</h1>

          <a
            href="/rss.xml"
            target="_blank"
            aria-label="RSS feed"
            title="RSS Feed"
          >
            <IconRss
              width={20}
              height={20}
              class="scale-125 stroke-accent stroke-3 rtl:-rotate-90"
            />
            <span class="sr-only">RSS Feed</span>
          </a>
        </div>

        <p class="mt-4 max-w-2xl text-slate-600">
          A long-term log of systems, algorithms, and engineering practice.
        </p>
      </section>

      <!-- Hero carousel -->
      <HeroCarousel items={heroItems} />

      <!-- Featured post (single, editorial) -->
      {featuredPost && (
        <section class="mt-10">
          <FeaturedPostCard {...featuredPost} />
        </section>
      )}

      <!-- Main content + sidebar -->
      <div class="mt-10 grid grid-cols-1 gap-10 lg:grid-cols-12">
        <!-- Main post list -->
        <section class="lg:col-span-8">
          <h2 class="text-2xl font-semibold tracking-wide">Latest</h2>

          <Hr />

          <ul class="space-y-6">
            {listItems.map((data) => (
              <li>
                {/* Reuse existing Card component for minimal refactor */}
                <PostCardHorizontal {...data} />
              </li>
            ))}
          </ul>

          <div class="my-8 text-center">
            <LinkButton href="/posts/">
              All Posts
              <IconArrowRight class="inline-block rtl:-rotate-180" />
            </LinkButton>
          </div>
        </section>

        <!-- Sidebar -->
        <aside class="lg:col-span-4">
          <Sidebar entries={sortedPosts} />
        </aside>
      </div>
    </div>
  </main>

  <Footer />
</Layout>

<script>
  /**
   * Preserve back-navigation behavior for post detail pages.
   * This allows returning to the homepage correctly.
   */
  document.addEventListener("astro:page-load", () => {
    const indexLayout = document
      .querySelector("#main-content")
      ?.dataset?.layout;

    if (indexLayout) {
      sessionStorage.setItem("backUrl", "/");
    }
  });
</script>
