---
/**
 * HeroCarousel - Clean Caption Bar Style
 *
 * Works for both artistic images AND content-rich images (diagrams, etc.)
 * - Image displays fully without text overlay interference
 * - Clean caption bar at bottom with solid background
 * - Large italic title, inline meta
 */

import { getPathFromEntry } from "@/utils/getPath";

const { items } = Astro.props;

function coverOf(entry: any) {
  const ogImage = entry.data?.ogImage;
  if (!ogImage) return undefined;
  return typeof ogImage === "string" ? ogImage : ogImage?.src;
}

function asArray(v: unknown): string[] {
  if (!v) return [];
  if (Array.isArray(v)) return v.filter(Boolean).map(String);
  return [String(v)];
}

function authorOf(entry: any): string | undefined {
  const a = entry.data?.author;
  if (typeof a === "string" && a.trim()) return a.trim();
  const authors = asArray(entry.data?.authors);
  return authors.length ? authors[0] : undefined;
}

function formatDate(entry: any): string | undefined {
  const d = entry.data?.datetime || entry.data?.pubDatetime;
  if (!d) return undefined;
  const date = new Date(d);
  const day = date.getDate();
  const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  const month = months[date.getMonth()];
  const year = date.getFullYear();
  return `${day} ${month}, ${year}`;
}

function categoriesOf(entry: any): string[] {
  return asArray(entry.data?.categories);
}
function tagsOf(entry: any): string[] {
  return asArray(entry.data?.tags);
}
---

<section class="hero-section" data-hero-root>
  <div class="carousel-container">
    <div class="carousel-scroller" data-carousel aria-label="Featured posts carousel">
      {items.map((entry: any, idx: number) => {
        const author = authorOf(entry);
        const date = formatDate(entry);
        const categories = categoriesOf(entry);
        const tags = tagsOf(entry);

        return (
          <article class="carousel-slide" data-slide data-index={idx}>
            <a href={getPathFromEntry(entry)} class="slide-link">
              {/* Background image - displays fully */}
              {coverOf(entry) ? (
                <img
                  src={coverOf(entry)}
                  alt={entry.data?.title ?? entry.slug}
                  class="slide-img"
                  loading={idx === 0 ? "eager" : "lazy"}
                />
              ) : (
                <div class="carousel-placeholder" />
              )}

              {/* Caption bar at bottom */}
              <div class="caption-bar">
                <h2 class="caption-title">{entry.data?.title ?? entry.slug}</h2>

                <div class="caption-meta">
                  {author && (
                    <span class="meta-item">
                      <span class="meta-icon">ðŸ‘¤</span>
                      <span>{author}</span>
                    </span>
                  )}

                  {date && (
                    <span class="meta-item">
                      <span class="meta-label">Date :</span>
                      <span>{date}</span>
                    </span>
                  )}

                  {categories.length > 0 && (
                    <span class="meta-item">
                      <span class="meta-label">Categories :</span>
                      <span class="meta-links">{categories.join(" , ")}</span>
                    </span>
                  )}

                  {tags.length > 0 && (
                    <span class="meta-item">
                      <span class="meta-label">Tags :</span>
                      <span class="meta-links">{tags.join(" , ")}</span>
                    </span>
                  )}
                </div>
              </div>
            </a>
          </article>
        );
      })}
    </div>

    {/* Navigation arrows */}
    <button class="nav-btn nav-prev" data-prev aria-label="Previous slide" type="button">
      <svg width="10" height="18" viewBox="0 0 10 18" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M9 1L1 9L9 17" />
      </svg>
    </button>
    <button class="nav-btn nav-next" data-next aria-label="Next slide" type="button">
      <svg width="10" height="18" viewBox="0 0 10 18" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M1 1L9 9L1 17" />
      </svg>
    </button>

    {/* Dots indicator */}
    <div class="dots-container">
      {items.map((_: any, idx: number) => (
        <button
          class="dot"
          data-dot
          data-dot-index={idx}
          aria-label={`Go to slide ${idx + 1}`}
          type="button"
        />
      ))}
    </div>
  </div>
</section>

<style>
  .hero-section {
    margin-top: 1rem;
  }

  .carousel-container {
    position: relative;
    overflow: hidden;
    border-radius: 0.75rem;
    background: #1a1a1a;
  }

  .carousel-scroller {
    display: flex;
    scroll-snap-type: x mandatory;
    overflow-x: auto;
    scrollbar-width: none;
    scroll-behavior: smooth;
  }
  .carousel-scroller::-webkit-scrollbar {
    display: none;
  }

  .carousel-slide {
    position: relative;
    width: 100%;
    flex: none;
    scroll-snap-align: start;
    aspect-ratio: 16 / 9;
    min-height: 380px;
    max-height: 580px;
  }

  .slide-link {
    display: block;
    width: 100%;
    height: 100%;
    position: relative;
    text-decoration: none;
  }

  /* Image: full display, no cropping */
  .slide-img {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
  }

  .carousel-placeholder {
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
  }

  /* Caption bar - solid background at bottom */
  .caption-bar {
    position: absolute;
    left: 0;
    right: 0;
    bottom: 0;
    padding: 1.25rem 1.75rem;
    padding-bottom: 3.5rem; /* space for dots */
    background: rgba(30, 30, 30, 0.92);
    text-align: center;
  }

  /* Title: large, elegant italic */
  .caption-title {
    margin: 0;
    font-family: 'Playfair Display', Georgia, 'Times New Roman', serif;
    font-size: clamp(1.4rem, 3.5vw, 2.4rem);
    font-weight: 400;
    font-style: italic;
    line-height: 1.25;
    color: #fff;
  }

  /* Meta: inline row */
  .caption-meta {
    margin-top: 0.6rem;
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    font-size: 0.88rem;
    color: rgba(255, 255, 255, 0.85);
  }

  .meta-item {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
  }

  .meta-icon {
    opacity: 0.9;
  }

  .meta-label {
    color: rgba(255, 255, 255, 0.7);
  }

  .meta-links {
    text-decoration: underline;
    text-underline-offset: 2px;
    text-decoration-color: rgba(255, 255, 255, 0.4);
  }

  /* Navigation buttons */
  .nav-btn {
    position: absolute;
    top: calc(50% - 2rem); /* offset for caption bar */
    transform: translateY(-50%);
    width: 44px;
    height: 44px;
    border-radius: 50%;
    border: none;
    background: rgba(255, 255, 255, 0.15);
    color: rgba(255, 255, 255, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .nav-btn:hover {
    background: rgba(255, 255, 255, 0.25);
    color: #fff;
  }
  .nav-prev {
    left: 0.75rem;
  }
  .nav-next {
    right: 0.75rem;
  }

  /* Dots */
  .dots-container {
    position: absolute;
    bottom: 1rem;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 0.5rem;
  }

  .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    border: none;
    background: rgba(255, 255, 255, 0.4);
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .dot:hover {
    background: rgba(255, 255, 255, 0.6);
  }
  .dot.active {
    background: #e74c3c;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .carousel-slide {
      min-height: 280px;
      aspect-ratio: 4 / 3;
    }

    .caption-bar {
      padding: 1rem 1.25rem;
      padding-bottom: 3rem;
    }

    .caption-title {
      font-size: 1.2rem;
    }

    .caption-meta {
      font-size: 0.75rem;
      gap: 0.4rem;
    }

    .nav-btn {
      width: 36px;
      height: 36px;
    }
  }
</style>

<script is:inline>
  /**
   * Carousel controller - Logbook style
   */
  const root = document.querySelector("[data-hero-root]");
  const scroller = root?.querySelector("[data-carousel]");
  const prev = root?.querySelector("[data-prev]");
  const next = root?.querySelector("[data-next]");
  const slides = Array.from(root?.querySelectorAll("[data-slide]") ?? []);
  const dots = Array.from(root?.querySelectorAll("[data-dot]") ?? []);

  if (root && scroller && slides.length > 0) {
    const total = slides.length;
    let activeIndex = 0;

    const setActive = (index) => {
      activeIndex = index;
      dots.forEach((dot, i) => {
        dot.classList.toggle("active", i === index);
      });
    };

    const leftOfIndex = (index) => {
      const target = slides[index];
      if (!target) return null;
      return target.offsetLeft;
    };

    const scrollToIndex = (index) => {
      const left = leftOfIndex(index);
      if (left == null) return;
      scroller.scrollTo({ left, behavior: "smooth" });
    };

    const scrollByOne = (direction) => {
      const width = scroller.clientWidth;
      scroller.scrollBy({ left: direction * width, behavior: "smooth" });
    };

    prev?.addEventListener("click", () => scrollByOne(-1));
    next?.addEventListener("click", () => scrollByOne(1));

    dots.forEach((dot) => {
      dot.addEventListener("click", () => {
        const idx = Number(dot.getAttribute("data-dot-index"));
        if (!Number.isNaN(idx)) scrollToIndex(idx);
      });
    });

    const io = new IntersectionObserver(
      (entries) => {
        let best = null;
        for (const e of entries) {
          if (!best || e.intersectionRatio > best.intersectionRatio) best = e;
        }
        if (!best || !best.isIntersecting) return;
        const idx = Number(best.target.getAttribute("data-index"));
        if (!Number.isNaN(idx)) setActive(idx);
      },
      { root: scroller, threshold: [0.4, 0.6, 0.8] }
    );

    slides.forEach((s) => io.observe(s));

    // Autoplay
    const AUTOPLAY_MS = 6000;
    const prefersReducedMotion =
      window.matchMedia &&
      window.matchMedia("(prefers-reduced-motion: reduce)").matches;

    let timer = null;
    let paused = false;

    const stopAutoplay = () => {
      if (timer) {
        clearInterval(timer);
        timer = null;
      }
    };

    const startAutoplay = () => {
      if (prefersReducedMotion) return;
      if (timer) return;
      timer = setInterval(() => {
        if (paused) return;
        const nextIndex = (activeIndex + 1) % total;
        scrollToIndex(nextIndex);
      }, AUTOPLAY_MS);
    };

    const pause = () => { paused = true; };
    const resume = () => { paused = false; };

    root.addEventListener("mouseenter", pause);
    root.addEventListener("mouseleave", resume);
    root.addEventListener("focusin", pause);
    root.addEventListener("focusout", resume);
    root.addEventListener("touchstart", pause, { passive: true });
    root.addEventListener("touchend", () => { setTimeout(resume, 800); }, { passive: true });

    if (total >= 2) startAutoplay();
    setActive(0);

    document.addEventListener("astro:before-swap", () => {
      stopAutoplay();
      io.disconnect();
    }, { once: true });
  }
</script>
