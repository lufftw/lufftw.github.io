---
/**
 * Sidebar
 *
 * Widgets:
 * - Search
 * - About
 * - Featured (frontmatter: featured: true)
 * - Categories (frontmatter: categories: string[])
 * - Latest (by current sorted order passed from the page)
 *
 * Notes:
 * - This component is intentionally "dumb": it expects the caller to pass entries
 *   already sorted in the desired order (e.g., newest first).
 * - Uses getPathFromEntry() to keep URL generation consistent across posts/notes.
 */

import { getPathFromEntry } from "@/utils/getPath";
import type { CollectionEntry } from "astro:content";

const { entries } = Astro.props;

// Featured items are derived from the passed entries list
const featured = entries.filter((e: CollectionEntry<"blog">) => e.data?.featured === true).slice(0, 5);

// Latest items (assumes entries are already sorted newest-first by the page)
const latest = entries.slice(0, 5);
// Debug: check latest array
// console.log("Sidebar latest array:", latest.map(e => ({
//   title: e.data?.title,
//   featured: e.data?.featured,
//   modDatetime: e.data?.modDatetime
// })));

// Aggregate category counts from frontmatter (using topics instead of categories)
const categories = new Map<string, number>();
for (const entry of entries) {
  for (const category of entry.data?.topics ?? []) {
    categories.set(category, (categories.get(category) ?? 0) + 1);
  }
}
const categoryList = [...categories.entries()]
  .sort((a, b) => b[1] - a[1])
  .slice(0, 10);
---

<div class="space-y-8">
  <!-- Search widget -->
  <!-- Following AstroPaper standard: use dark: variant for theme-aware styling -->
  <section class="rounded-2xl border border-slate-200 p-5 dark:border-slate-800">
    <h3 class="text-sm font-semibold tracking-wide text-slate-900 dark:text-slate-100">Search</h3>

    <form class="mt-3 flex gap-2" action="/search">
      <input
        name="q"
        class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-900 outline-none focus:ring dark:border-slate-800 dark:bg-slate-950 dark:text-slate-100"
        placeholder="Type to searchâ€¦"
        autocomplete="off"
      />
      <button
        type="submit"
        class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 hover:bg-slate-50 dark:border-slate-800 dark:bg-slate-950 dark:text-slate-300 dark:hover:bg-slate-900"
      >
        Go
      </button>
    </form>
  </section>

  <!-- About widget -->
  <section class="rounded-2xl border border-slate-200 p-5 dark:border-slate-800">
    <h3 class="text-sm font-semibold tracking-wide text-slate-900 dark:text-slate-100">About</h3>
    <p class="mt-3 text-sm leading-relaxed text-slate-600 dark:text-slate-400">
      Engineer / Researcher. Systems + algorithms. Long-term notes and posts.
    </p>
  </section>

  <!-- Featured widget -->
  <section class="rounded-2xl border border-slate-200 p-5 dark:border-slate-800">
    <div class="flex items-center justify-between">
      <h3 class="text-sm font-semibold tracking-wide text-slate-900 dark:text-slate-100">Featured</h3>
      <span class="rounded-full bg-slate-100 px-2 py-1 text-[11px] font-medium text-slate-600 dark:bg-slate-800 dark:text-slate-400">
        curated
      </span>
    </div>

    {featured.length === 0 ? (
      <p class="mt-3 text-sm text-slate-500 dark:text-slate-500">No featured posts yet.</p>
    ) : (
      <ul class="mt-3 space-y-3 text-sm">
        {featured.map((entry: CollectionEntry<"blog">) => (
          <li class="group">
            <a
              href={getPathFromEntry(entry)}
              class="block font-medium text-slate-800 group-hover:underline dark:text-slate-200"
            >
              {entry.data?.title ?? entry.id}
            </a>
            {entry.data?.pubDatetime && (
              <div class="mt-1 text-xs text-slate-400 dark:text-slate-500">
                {entry.data.pubDatetime.toLocaleDateString()}
              </div>
            )}
          </li>
        ))}
      </ul>
    )}
  </section>

  <!-- Categories widget -->
  <section class="rounded-2xl border border-slate-200 p-5 dark:border-slate-800">
    <h3 class="text-sm font-semibold tracking-wide text-slate-900 dark:text-slate-100">Categories</h3>

    {categoryList.length === 0 ? (
      <p class="mt-3 text-sm text-slate-500 dark:text-slate-500">No categories yet.</p>
    ) : (
      <ul class="mt-3 space-y-2 text-sm">
        {categoryList.map(([name, count]) => (
          <li class="flex items-center justify-between">
            <a
              href={`/categories/${String(name).toLowerCase()}/`}
              class="text-slate-700 hover:underline dark:text-slate-300"
            >
              {name}
            </a>
            <span class="text-slate-400 dark:text-slate-500">{count}</span>
          </li>
        ))}
      </ul>
    )}
  </section>

  <!-- Latest widget -->
  <section class="rounded-2xl border border-slate-200 p-5 dark:border-slate-800">
    <h3 class="text-sm font-semibold tracking-wide text-slate-900 dark:text-slate-100">Latest</h3>

    <ul class="mt-3 space-y-3 text-sm">
      {latest.map((entry: CollectionEntry<"blog">) => (
        <li class="group">
          <a
            href={getPathFromEntry(entry)}
            class="block font-medium text-slate-800 group-hover:underline dark:text-slate-200"
          >
            {entry.data?.title ?? entry.id}
          </a>
          {entry.data?.pubDatetime && (
            <div class="mt-1 text-xs text-slate-400 dark:text-slate-500">
              {entry.data.pubDatetime.toLocaleDateString()}
            </div>
          )}
        </li>
      ))}
    </ul>
  </section>
</div>
